---
import Layout from '../../../presentation/layouts/Layout.astro';
import Header from '../../../presentation/components/Header.astro';
import Footer from '../../../presentation/components/Footer.astro';
import BackLink from '../../../presentation/components/ui/BackLink.astro';
import MetaPill from '../../../presentation/components/ui/MetaPill.astro';
import Section from '../../../presentation/components/common/Section.astro';
import SkillsGrid from '../../../presentation/components/skills/SkillsGrid.astro';
import ProjectsGrid from '../../../presentation/components/projects/ProjectsGrid.astro';

import type { Language } from '@domain/models/Language';
import { supportedLanguages, translate } from '@domain/models/Language';
import { formatDateRange, COMPANY_LINKS } from '@/core';

import { InMemoryWorkExperienceRepository, InMemoryProjectRepository, InMemoryPersonalInfoRepository, InMemorySkillRepository } from '@/data';
import { GetWorkExperiencesUseCase, GetProjectsByTypeUseCase, GetPersonalInfoUseCase, GetSkillsUseCase  } from '@/domain';

const workExperiences = await new GetWorkExperiencesUseCase(new InMemoryWorkExperienceRepository()).execute();
const projects = await new GetProjectsByTypeUseCase(new InMemoryProjectRepository()).execute('work');
const personalInfo = await new GetPersonalInfoUseCase(new InMemoryPersonalInfoRepository()).execute();
const skills = await new GetSkillsUseCase(new InMemorySkillRepository()).execute();

export async function getStaticPaths() {
    const paths = [];
    for (const l of supportedLanguages) {
        for (const work of workExperiences) {
            paths.push({ params: { lang: l, id: work.id } });
        }
    }
    return paths;
}
const lang: Language = Astro.params.lang as Language;
const workId = Astro.params.id as string;

// Find the current work experience
const workExperience = workExperiences.find((w) => w.id === workId);
if (!workExperience) return Astro.redirect(`/${lang}/`);

// Get related projects
const relatedProjects = projects.filter((project: any) =>
    project.relatedTo?.includes(workExperience.id)
);

// Helper to linkify company names with URLs from constants
const linkifyCompanies = (text: string): string => {
    let result = text;
    for (const [company, url] of Object.entries(COMPANY_LINKS)) {
        const regex = new RegExp(`\\b${company}\\b`, 'g');
        result = result.replace(regex, `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-[var(--color-primary)] font-semibold no-underline border-b-2 border-transparent transition-colors duration-150 hover:text-[var(--color-primary-dark)] hover:border-b-[var(--color-primary)]">${company}</a>`);
    }
    return result;
};


import { InMemoryCommonLabelsRepository, InMemoryProjectLabelsRepository, InMemoryWorkLabelsRepository } from '@/data';
import { GetCommonLabelsUseCase, GetProjectLabelsUseCase, GetWorkLabelsUseCase } from '@/domain';

const commonLabels = await new GetCommonLabelsUseCase(new InMemoryCommonLabelsRepository()).execute();
const projectLabels = await new GetProjectLabelsUseCase(new InMemoryProjectLabelsRepository()).execute();
const workLabels = await new GetWorkLabelsUseCase(new InMemoryWorkLabelsRepository()).execute();
---

<Layout lang={lang} title={`${translate(workExperience.position, lang)} - ${personalInfo.name}`} description={translate(workExperience.description, lang)}>
    <Header lang={lang} personalInfo={personalInfo} />
    
    <main class="min-h-screen py-16 bg-gradient-to-br from-[var(--color-bg-primary)] to-[var(--color-bg-secondary)]">
        <div class="max-w-6xl mx-auto px-4">
            <BackLink href={`/${lang}/#work`} text={translate(commonLabels.back, lang)} />
            <section class="mb-12">
                <div class="bg-[var(--color-bg-primary)]/40 border border-[var(--color-primary)] rounded-2xl p-9 shadow-[0_16px_36px_rgba(0,0,0,0.08)]">
                    <div class="flex flex-col gap-2 mb-4">
                        <h1 class="text-4xl md:text-5xl font-extrabold leading-tight text-[var(--color-text-primary)]">{translate(workExperience.position, lang)}</h1>
                    </div>

                    <div class="flex flex-wrap gap-3 mb-4">
                        <MetaPill variant="primary" href={workExperience.companyUrl} target="_blank" rel="noopener noreferrer">
                            {workExperience.company}
                        </MetaPill>
                        <MetaPill variant="subtle">{workExperience.location}</MetaPill>
                        <MetaPill variant="subtle">{formatDateRange(workExperience.startDate, workExperience.endDate, lang, translate(commonLabels.current, lang))}</MetaPill>
                    </div>

                    <p class="text-[var(--color-text-primary)] text-base leading-relaxed">{translate(workExperience.description, lang)}</p>
                </div>
            </section>

            <Section title={translate(projectLabels.technologies, lang)} class="mb-8">
                <SkillsGrid skillIds={workExperience.technologies} skills={skills.filter(skill => workExperience.technologies.includes(skill.id))} columns={4} compact={true} />
            </Section>

            {workExperience.achievements.length > 0 && (
                <Section title={translate(workLabels.achievements, lang)} class="mb-8">
                    <ul class="list-none p-0 m-0 space-y-3">
                        {workExperience.achievements.map((achievement) => (
                                <li class="p-4 bg-[var(--color-bg-primary)] border-l-4 border-[var(--color-primary)] rounded-md text-[var(--color-text-primary)] leading-relaxed" set:html={linkifyCompanies(translate(achievement, lang))}></li>
                            ))}
                    </ul>
                </Section>
            )}

            {relatedProjects.length > 0 && (
                <Section title={translate(workLabels.projects, lang)} class="mb-8">
                    <ProjectsGrid 
                        projects={relatedProjects}
                        lang={lang}
                        commonLabels={commonLabels}
                        projectLabels={projectLabels}
                        columns={2}
                        showTechnologies={false}
                        skills={skills}
                    />
                </Section>
            )}
        </div>
    </main>

    <Footer lang={lang} />
</Layout>
