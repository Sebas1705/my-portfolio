---
import Layout from '@/presentation/layouts/Layout.astro';
import Header from '@/presentation/components/sections/Header.astro';
import Footer from '@/presentation/components/sections/Footer.astro';
import BackLink from '@/presentation/components/ui/BackLink.astro';
import MetaPill from '@/presentation/components/ui/MetaPill.astro';
import Section from '@/presentation/components/common/Section.astro';
import SkillsGrid from '@/presentation/components/skills/SkillsGrid.astro';
import ProjectsGrid from '@/presentation/components/projects/ProjectsGrid.astro';

import type { Language } from '@domain/models/Language';
import { supportedLanguages, translate } from '@domain/models/Language';
import { formatDateRange, linkify } from '@/core';

import { InMemoryWorkExperienceRepository, InMemoryProjectRepository, InMemoryPersonalInfoRepository, InMemorySkillRepository } from '@/data';
import { GetWorkExperiencesUseCase, GetProjectsByTypeUseCase, GetPersonalInfoUseCase, GetSkillsUseCase  } from '@/domain';

const personalInfo = await new GetPersonalInfoUseCase(new InMemoryPersonalInfoRepository()).execute();
const skills = await new GetSkillsUseCase(new InMemorySkillRepository()).execute();

export async function getStaticPaths() {
    const workExperiences = await new GetWorkExperiencesUseCase(new InMemoryWorkExperienceRepository()).execute();
    const paths = [];
    for (const l of supportedLanguages) {
        for (const work of workExperiences) {
            paths.push({ params: { lang: l, id: work.id } });
        }
    }
    return paths;
}
const lang: Language = Astro.params.lang as Language;
const workId = Astro.params.id as string;


// Find the current work experience
const workExperiences = await new GetWorkExperiencesUseCase(new InMemoryWorkExperienceRepository()).execute();
const workExperience = workExperiences.find((w: any) => w.id === workId);
if (!workExperience) return Astro.redirect(`/${lang}/`);

// Get related projects
const projects = await new GetProjectsByTypeUseCase(new InMemoryProjectRepository()).execute('work');
const relatedProjects = projects.filter((project: any) =>
    project.relatedTo?.includes(workExperience.id)
);

import { InMemoryCommonLabelsRepository, InMemoryProjectLabelsRepository, InMemoryWorkLabelsRepository } from '@/data';
import { GetCommonLabelsUseCase, GetProjectLabelsUseCase, GetWorkLabelsUseCase } from '@/domain';

const commonLabels = await new GetCommonLabelsUseCase(new InMemoryCommonLabelsRepository()).execute();
const projectLabels = await new GetProjectLabelsUseCase(new InMemoryProjectLabelsRepository()).execute();
const workLabels = await new GetWorkLabelsUseCase(new InMemoryWorkLabelsRepository()).execute();
---

<Layout lang={lang} title={`${translate(workExperience.position, lang)} - ${personalInfo.name}`} description={translate(workExperience.description, lang)}>
    <Header lang={lang} personalInfo={personalInfo} />

    <Section background="binary-rain">
        <div class="px-5 md:px-10 lg:px-15 mt-5">
            <BackLink href={`/${lang}/#work`} text={translate(commonLabels.back, lang)} />
            <section class="mb-5 mt-5">
                <div class="bg-bg-surface-alt-v border border-primary-v rounded-2xl p-9">
                    <div class="flex flex-col gap-2 mb-4">
                        <h1 class="text-4xl md:text-5xl font-extrabold leading-tight text-primary-v">{translate(workExperience.position, lang)}</h1>
                    </div>

                    <div class="flex flex-wrap gap-3 mb-4">
                        <MetaPill variant="primary" href={workExperience.companyUrl} target="_blank" rel="noopener noreferrer">
                            {workExperience.company}
                        </MetaPill>
                        <MetaPill variant="subtle">{translate(workExperience.location, lang)}</MetaPill>
                        <MetaPill variant="subtle">{formatDateRange(workExperience.startDate, workExperience.endDate, lang, translate(commonLabels.current, lang))}</MetaPill>
                    </div>

                    <p class="text-bg-inverse-alt-v text-md leading-relaxed">{translate(workExperience.description, lang)}</p>
                </div>
            </section>

            <Section title={translate(projectLabels.technologies, lang)}>
                <SkillsGrid skillIds={workExperience.technologies} skills={skills.filter(skill => workExperience.technologies.includes(skill.id))}/>
            </Section>

            {workExperience.achievements.length > 0 && (
                <Section title={translate(workLabels.achievements, lang)}>
                    <ul class="list-none space-y-3 mt-5">
                        {workExperience.achievements.map((achievement) => (
                            <li class="p-5 bg-bg-surface-v border-l-4 border-primary-v rounded-md text-bg-inverse-alt-v leading-relaxed" set:html={linkify(translate(achievement, lang))}></li>
                        ))}
                    </ul>
                </Section>
            )}

            {relatedProjects.length > 0 && (
                <Section title={translate(workLabels.projects, lang)}>
                    <ProjectsGrid 
                        projects={relatedProjects}
                        lang={lang}
                        commonLabels={commonLabels}
                        projectLabels={projectLabels}
                        columns={2}
                        showTechnologies={false}
                        skills={skills}
                    />
                </Section>
            )}
        </div>
    </Section>

    <Footer lang={lang} />
</Layout>
