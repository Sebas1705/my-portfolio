---
import Layout from '@/presentation/layouts/Layout.astro';
import Header from '@/presentation/components/Header.astro';
import Footer from '@/presentation/components/Footer.astro';
import BackLink from '@/presentation/components/ui/BackLink.astro';
import MetaPill from '@/presentation/components/ui/MetaPill.astro';
import { Section } from '@/presentation/components/common';
import { ProjectsGrid } from '@/presentation/components/projects';

import type { Language } from '@domain/models/Language';
import personalInfoData from '../../../data/datasources/personalInfoData.json';
import academicExperiencesData from '../../../data/datasources/academicExperiencesData.json';
import projectsData from '../../../data/datasources/projectsData.json';
import navigationLabelsData from '../../../data/datasources/labels/navigationLabels.json';
import educationLabelsData from '../../../data/datasources/labels/educationLabels.json';
import commonLabelsData from '../../../data/datasources/labels/commonLabels.json';
import projectLabelsData from '../../../data/datasources/labels/projectLabels.json';
import aboutLabelsData from '../../../data/datasources/labels/aboutLabels.json';
import workLabelsData from '../../../data/datasources/labels/workLabels.json';
import footerLabelsData from '../../../data/datasources/labels/footerLabels.json';
import { supportedLanguages, translate } from '@domain/models/Language';
import { formatDateRange } from '@/core';

export async function getStaticPaths() {
    const paths = [];
    for (const l of supportedLanguages) {
        for (const experience of academicExperiencesData) {
            paths.push({ params: { lang: l, id: experience.id } });
        }
    }
    return paths;
}

const paramsLang = Astro.params.lang as Language | undefined;
const lang: Language = supportedLanguages.includes(paramsLang as Language) ? (paramsLang as Language) : 'en';
const experienceId = Astro.params.id as string;


const getStringFromTranslations = (value: any, lang: Language) => {
    if (!value) return '';
    if (typeof value === 'string') return value;
    if (typeof value === 'object') return value[lang] || Object.values(value)[0] || '';
    return '';
};


const personalInfo = personalInfoData;
const experiences = academicExperiencesData;
const projects = projectsData;

// Use raw label objects (Translations) from datasources so domain translate can be used in components
const navigationLabels = navigationLabelsData;
const commonLabels = commonLabelsData;
const educationLabels = educationLabelsData;
const projectLabels = projectLabelsData;
const footerLabels = footerLabelsData;
const aboutLabels = aboutLabelsData;
const workLabels = workLabelsData;

// Combine labels needed for this page
const labels = { 
    ...navigationLabels,
    ...educationLabels,
    ...commonLabels,
    ...projectLabels,
    ...footerLabels,
    ...aboutLabels,
    ...workLabels
};

const experience = experiences.find((e) => e.id === experienceId);
if (!experience) return Astro.redirect(`/${lang}/`);

const relatedProjects = projects.filter((project: any) =>
    project.relatedTo?.includes(experience.id)
);
---

    <Layout lang={lang} title={`${getStringFromTranslations(experience.degree, lang)} - ${personalInfo.name}`} description={getStringFromTranslations(experience.description, lang)}>
    <Header labels={labels} lang={lang} personalInfo={personalInfo} />
    
    <main class="education-detail-page">
        <div class="container">
            <div class="page-header">
                <BackLink href={`/${lang}/#education`} text={labels.back} />
                <h1>{getStringFromTranslations(experience.degree, lang)}</h1>
                <div class="education-meta-header">
                    <MetaPill variant="primary">
                        {getStringFromTranslations(experience.institution, lang)}
                    </MetaPill>
                    <MetaPill variant="subtle">
                        {getStringFromTranslations(experience.field, lang)}
                    </MetaPill>
                    <MetaPill variant="subtle">
                        {getStringFromTranslations(experience.location, lang)}
                    </MetaPill>
                    <MetaPill variant="subtle">
                        {formatDateRange(experience.startDate, experience.endDate, lang, labels.workCurrent)}
                    </MetaPill>
                </div>
            </div>

            <Section title={translate(labels.aboutTitle, lang)}>
                <p class="education-description">{translate(experience.description, lang)}</p>
            </Section>

            {experience.achievements.length > 0 && (
                <Section title={translate(labels.educationAchievements, lang)}>
                    <ul class="achievements-list">
                        {experience.achievements.map((achievement: any) => (
                            <li>{typeof achievement === 'string' ? achievement : achievement[lang] || achievement}</li>
                        ))}
                    </ul>
                </Section>
            )}

            {relatedProjects.length > 0 && (
                <Section title={translate(labels.educationProjects, lang)}>
                    <ProjectsGrid 
                        projects={relatedProjects}
                        lang={lang}
                        labels={labels}
                        showImages={false}
                        showTechnologies={true}
                        maxTech={5}
                    />
                </Section>
            )}
        </div>
    </main>

    <Footer labels={labels} lang={lang} />
</Layout>

<style>
    .education-detail-page {
        min-height: 100vh;
        padding: 4rem 0;
        background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 100%);
    }

    .page-header {
        text-align: center;
        margin-bottom: 4rem;
    }

    .page-header h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--color-text-primary);
    }

    .education-meta-header {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        align-items: center;
        margin-top: 1rem;
    }

    .institution-name {
        font-size: 1.1rem;
        line-height: 1.8;
        color: var(--color-text-primary);
        margin: 0;
    }

    .achievements-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .achievements-list li {
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: var(--color-bg-primary);
        border-left: 4px solid var(--color-primary);
        border-radius: var(--radius-md);
        color: var(--color-text-primary);
        line-height: 1.6;
    }

    .achievements-list li:last-child {
        margin-bottom: 0;
    }

    .project-header h3 {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--color-text-primary);
        margin: 0 0 1rem 0;
    }

    .project-description {
        color: var(--color-text-secondary);
        font-size: 0.95rem;
        line-height: 1.6;
        margin-bottom: 1rem;
        flex-grow: 1;
    }

    .project-tech {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .tech-badge {
        background: var(--color-primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-sm);
        font-size: 0.85rem;
        font-weight: 500;
    }

    .project-links {
        display: flex;
        gap: 1rem;
    }

    .project-link {
        flex: 1;
        text-align: center;
     