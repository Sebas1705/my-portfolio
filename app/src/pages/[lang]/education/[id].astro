---
import Layout from '@/presentation/layouts/Layout.astro';
import Header from '@/presentation/components/Header.astro';
import Footer from '@/presentation/components/Footer.astro';
import BackLink from '@/presentation/components/ui/BackLink.astro';
import MetaPill from '@/presentation/components/ui/MetaPill.astro';
import Section from '@/presentation/components/common/Section.astro';
import ProjectsGrid from '@/presentation/components/projects/ProjectsGrid.astro';

import type { Language } from '@/domain';
import { supportedLanguages, translate } from '@/domain';
import { formatDateRange } from '@/core';

import { InMemoryAcademicExperienceRepository, InMemoryProjectRepository, InMemoryPersonalInfoRepository } from '@/data';
import { GetAcademicExperiencesUseCase, GetProjectsByTypeUseCase, GetPersonalInfoUseCase } from '@/domain';

const academicExperiences = await new GetAcademicExperiencesUseCase(new InMemoryAcademicExperienceRepository()).execute();
const projects = await new GetProjectsByTypeUseCase(new InMemoryProjectRepository()).execute('academic');
const personalInfo = await new GetPersonalInfoUseCase(new InMemoryPersonalInfoRepository()).execute();

export async function getStaticPaths() {
    const paths = [];
    for (const l of supportedLanguages) {
        for (const experience of academicExperiences) {
            paths.push({ params: { lang: l, id: experience.id } });
        }
    }
    return paths;
}
const lang: Language = Astro.params.lang as Language;
const experienceId = Astro.params.id as string;

const academicExperience = academicExperiences.find((e) => e.id === experienceId);
if (!academicExperience) return Astro.redirect(`/${lang}/`);

const relatedProjects = projects.filter((project: any) =>
    project.relatedTo?.includes(academicExperience.id)
);

import { InMemoryCommonLabelsRepository, InMemoryEducationLabelsRepository, InMemoryProjectLabelsRepository } from '@/data';
import { GetCommonLabelsUseCase, GetEducationLabelsUseCase, GetProjectLabelsUseCase } from '@/domain';

const commonLabels = await new GetCommonLabelsUseCase(new InMemoryCommonLabelsRepository()).execute();
const educationLabels = await new GetEducationLabelsUseCase(new InMemoryEducationLabelsRepository()).execute();
const projectLabels = await new GetProjectLabelsUseCase(new InMemoryProjectLabelsRepository()).execute();
---

    <Layout lang={lang} title={`${translate(academicExperience.degree, lang)} - ${personalInfo.name}`} description={translate(academicExperience.description, lang)}>
    <Header lang={lang} personalInfo={personalInfo} />
    
    <main class="min-h-screen py-16 bg-gradient-to-br from-[var(--color-bg-primary)] to-[var(--color-bg-secondary)]">
        <div class="max-w-5xl mx-auto px-4">
            <div class="text-center mb-12">
                <BackLink href={`/${lang}/#education`} text={translate(commonLabels.back, lang)} />
                <h1 class="text-3xl md:text-4xl font-extrabold text-[var(--color-text-primary)] mt-4">{translate(academicExperience.degree, lang)}</h1>
                <div class="flex flex-col sm:flex-row justify-center gap-3 mt-4">
                    <MetaPill variant="primary">{translate(academicExperience.institution, lang)}</MetaPill>
                    <MetaPill variant="subtle">{translate(academicExperience.field, lang)}</MetaPill>
                    <MetaPill variant="subtle">{translate(academicExperience.location, lang)}</MetaPill>
                    <MetaPill variant="subtle">{formatDateRange(academicExperience.startDate, academicExperience.endDate, lang, translate(commonLabels.current, lang))}</MetaPill>
                </div>
            </div>

            <Section title={translate(educationLabels.title, lang)}>
                <p class="text-[var(--color-text-secondary)] leading-relaxed">{translate(academicExperience.description, lang)}</p>
            </Section>

            {academicExperience.achievements.length > 0 && (
                <Section title={translate(educationLabels.achievements, lang)}>
                    <ul class="list-none p-0 m-0 space-y-3">
                        {academicExperience.achievements.map((achievement: any) => (
                            <li class="p-4 bg-[var(--color-bg-primary)] border-l-4 border-[var(--color-primary)] rounded-md text-[var(--color-text-primary)] leading-relaxed">{typeof achievement === 'string' ? achievement : achievement[lang] || achievement}</li>
                        ))}
                    </ul>
                </Section>
            )}

            {relatedProjects.length > 0 && (
                <Section title={translate(educationLabels.projects, lang)}>
                    <ProjectsGrid 
                        projects={relatedProjects}
                        lang={lang}
                        commonLabels={commonLabels}
                        projectLabels={projectLabels}
                        showImages={false}
                        showTechnologies={true}
                        maxTech={5}
                    />
                </Section>
            )}
        </div>
    </main>

    <Footer lang={lang} />
</Layout>
     