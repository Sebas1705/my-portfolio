---
import Layout from '../presentation/layouts/Layout.astro';
import Header from '../presentation/components/Header.astro';
import Hero from '../presentation/components/Hero.astro';
import Skills from '../presentation/components/Skills.astro';
import SoftSkills from '../presentation/components/SoftSkills.astro';
import About from '../presentation/components/About.astro';
import WorkExperience from '../presentation/components/WorkExperience.astro';
import Education from '../presentation/components/Education.astro';
import Projects from '../presentation/components/Projects.astro';
import Contact from '../presentation/components/Contact.astro';
import Footer from '../presentation/components/Footer.astro';

import { GetPersonalInfoUseCase } from '@domain/use-cases';
import { GetWorkExperiencesUseCase } from '@domain/use-cases';
import { GetAcademicExperiencesUseCase } from '@domain/use-cases';
import { GetAllProjectsUseCase } from '@domain/use-cases';
import { GetAllSkillsUseCase } from '@domain/use-cases';
import { GetSoftSkillsUseCase } from '@domain/use-cases';
import { GetWorkLabelsUseCase, GetProjectLabelsUseCase, GetSkillsLabelsUseCase, GetAboutLabelsUseCase, GetSoftSkillsLabelsUseCase, GetContactLabelsUseCase } from '@domain/use-cases';

import { InMemoryPersonalInfoRepository, InMemoryWorkExperienceRepository, InMemoryAcademicExperienceRepository, InMemoryProjectRepository, InMemorySkillRepository, InMemorySoftSkillRepository, InMemoryWorkLabelsRepository, InMemoryProjectLabelsRepository, InMemorySkillsLabelsRepository, InMemoryAboutLabelsRepository, InMemorySoftSkillsLabelsRepository, InMemoryContactLabelsRepository } from '@data/repositories';

import type { Language } from '@domain/models';

// Default to Spanish, language will be determined on client-side from localStorage
const lang: Language = 'es';

const getString = (value: any): string => {
    if (typeof value === 'string') return value;
    if (typeof value === 'object' && value !== null) {
        return value[lang] || Object.values(value)[0] || '';
    }
    return '';
};

// Fetch data via use-cases + repositories (clean architecture)
const personalRepo = new InMemoryPersonalInfoRepository();
const workRepo = new InMemoryWorkExperienceRepository();
const academicRepo = new InMemoryAcademicExperienceRepository();
const projectRepo = new InMemoryProjectRepository();
const skillRepo = new InMemorySkillRepository();
const softSkillRepo = new InMemorySoftSkillRepository();

const personalUseCase = new GetPersonalInfoUseCase(personalRepo);
const workUseCase = new GetWorkExperiencesUseCase(workRepo);
const academicUseCase = new GetAcademicExperiencesUseCase(academicRepo);
const projectsUseCase = new GetAllProjectsUseCase(projectRepo);
const skillsUseCase = new GetAllSkillsUseCase(skillRepo);
const softSkillsUseCase = new GetSoftSkillsUseCase(softSkillRepo);

// Labels use-cases and repos
const workLabelsRepo = new InMemoryWorkLabelsRepository();
const projectLabelsRepo = new InMemoryProjectLabelsRepository();
const skillsLabelsRepo = new InMemorySkillsLabelsRepository();
const aboutLabelsRepo = new InMemoryAboutLabelsRepository();
const softSkillsLabelsRepo = new InMemorySoftSkillsLabelsRepository();
const contactLabelsRepo = new InMemoryContactLabelsRepository();

const workLabelsUseCase = new GetWorkLabelsUseCase(workLabelsRepo);
const projectLabelsUseCase = new GetProjectLabelsUseCase(projectLabelsRepo);
const skillsLabelsUseCase = new GetSkillsLabelsUseCase(skillsLabelsRepo);
const aboutLabelsUseCase = new GetAboutLabelsUseCase(aboutLabelsRepo);
const softSkillsLabelsUseCase = new GetSoftSkillsLabelsUseCase(softSkillsLabelsRepo);
const contactLabelsUseCase = new GetContactLabelsUseCase(contactLabelsRepo);

const personalInfo = await personalUseCase.execute();
const workExperiences = await workUseCase.execute();
const academicExperiences = await academicUseCase.execute();
const projects = await projectsUseCase.execute();
const skills = await skillsUseCase.execute();
const softSkills = await softSkillsUseCase.execute();

// fetch labels via use-cases
const workLabels = await workLabelsUseCase.execute();
const projectLabels = await projectLabelsUseCase.execute();
const skillsLabels = await skillsLabelsUseCase.execute();
const aboutLabels = await aboutLabelsUseCase.execute();
const softSkillsLabels = await softSkillsLabelsUseCase.execute();
const contactLabels = await contactLabelsUseCase.execute();
---

<Layout lang={lang} title={`${personalInfo.name} - ${getString(personalInfo.title)}`} description={getString(personalInfo.bio)}>
    <Header lang={lang} personalInfo={personalInfo} />
    
    <main>
        <Hero lang={lang} personalInfo={personalInfo} labels={aboutLabels} />
        <Skills lang={lang} skills={skills} labels={skillsLabels} />
        <SoftSkills lang={lang} softSkills={softSkills} labels={softSkillsLabels} />
        <About lang={lang} personalInfo={personalInfo} labels={aboutLabels} />
        <WorkExperience lang={lang} experiences={workExperiences} projects={projects} labels={workLabels} />
        <Education lang={lang} experiences={academicExperiences} projects={projects} />
        <Projects lang={lang} projects={projects} labels={projectLabels} />
        <Contact lang={lang} personalInfo={personalInfo} labels={contactLabels} />
    </main>

    <Footer lang={lang} />
</Layout>
