---
import type { Language } from '@/domain';
import { supportedLanguages, languageNames } from '@/domain';

interface Props {
    currentLang: Language;
}

const { currentLang } = Astro.props;

// Sort languages with current language first
const orderedLanguages = [
    currentLang,
    ...supportedLanguages.filter(lang => lang !== currentLang)
];
---

<div class="language-selector relative inline-block">
    <button
        id="language-toggle"
        class="language-button inline-flex items-center gap-2 px-3 py-1 rounded-md bg-gray-100 dark:bg-slate-800 text-indigo-600 border-2 border-indigo-600 font-semibold text-sm hover:bg-indigo-600 hover:text-white transition"
        aria-label="Change language"
        title="Change language"
    >
        <span class="current-lang">{currentLang.toUpperCase()}</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
        </svg>
    </button>
    
    <div id="language-dropdown" class="language-dropdown absolute top-full right-0 mt-2 bg-white dark:bg-slate-900 border-2 border-indigo-600 rounded-md shadow-lg min-w-[180px] max-h-96 overflow-y-auto z-50" hidden>
        {orderedLanguages.map((lng) => (
            <button class={`language-option flex items-center gap-3 w-full px-4 py-3 text-left transition ${lng === currentLang ? 'bg-indigo-600 text-white font-semibold' : 'text-slate-900 dark:text-slate-100 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-indigo-600'}`} data-lang={lng} data-active={lng === currentLang ? 'true' : 'false'}>
                <span class={`lang-code font-bold ${lng === currentLang ? 'text-white' : 'text-indigo-600'} min-w-[30px]`}>{lng.toUpperCase()}</span>
                <span class="lang-name text-sm flex-1">{languageNames[lng]}</span>
                {lng === currentLang ? (
                    <svg class="lang-check w-4 h-4" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                ) : (
                    <svg class="lang-check w-4 h-4 hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                )}
            </button>
        ))}
    </div>
</div>

<script>
    import { supportedLanguages, type Language } from "@/domain";

    const languageToggle = document.getElementById('language-toggle');
    const languageDropdown = document.getElementById('language-dropdown');
    const languageOptions = document.querySelectorAll('.language-option');

    if (languageToggle && languageDropdown) {
        languageToggle.addEventListener('click', () => {
            const isHidden = languageDropdown.hasAttribute('hidden');
            if (isHidden) {
                languageDropdown.removeAttribute('hidden');
            } else {
                languageDropdown.setAttribute('hidden', '');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!languageToggle.contains(e.target as Node) && !languageDropdown.contains(e.target as Node)) {
                languageDropdown.setAttribute('hidden', '');
            }
        });
    }

    languageOptions.forEach(option => {
        option.addEventListener('click', () => {
            const lang: string | null = option.getAttribute('data-lang');
            if (lang) {
                const currentPath: string = window.location.pathname;
                const pathSegments: string[] = currentPath.split('/').filter(Boolean);
                
                // Remove current language from path if exists
                if (supportedLanguages.includes(pathSegments[0] as Language)) {
                    pathSegments.shift();
                }
                
                // Build new path with selected language
                const newPath = `/${lang}/${pathSegments.join('/')}`;
                window.location.href = newPath;
            }
        });
    });
</script>
