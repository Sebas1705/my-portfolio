---
import type { Language } from '@domain/entities/Language';
import { supportedLanguages, languageNames } from '@infrastructure/i18n';

interface Props {
  currentLang: Language;
}

const { currentLang } = Astro.props;

// Sort languages with current language first
const orderedLanguages = [
  currentLang,
  ...supportedLanguages.filter(lang => lang !== currentLang)
];
---

<div class="language-selector">
  <button
    id="language-toggle"
    class="language-button"
    aria-label="Change language"
    title="Change language"
  >
    <span class="current-lang">{currentLang.toUpperCase()}</span>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="6 9 12 15 18 9"/>
    </svg>
  </button>
  
  <div id="language-dropdown" class="language-dropdown" hidden>
    {orderedLanguages.map((lang) => (
      <button class="language-option" data-lang={lang} data-active={lang === currentLang ? 'true' : 'false'}>
        <span class="lang-code">{lang.toUpperCase()}</span>
        <span class="lang-name">{languageNames[lang]}</span>
        {lang === currentLang && (
          <svg class="lang-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        )}
      </button>
    ))}
  </div>
</div>

<style>
  .language-selector {
    position: relative;
  }

  .language-button {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-md);
    background-color: var(--color-bg-secondary);
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
    font-weight: 600;
    font-size: 0.875rem;
    transition: all var(--transition-fast);
    cursor: pointer;
  }

  .language-button:hover {
    background-color: var(--color-primary);
    color: var(--color-bg-primary);
  }

  [data-theme="dark"] .language-button {
    background-color: var(--color-bg-secondary);
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
  }

  [data-theme="dark"] .language-button:hover {
    background-color: var(--color-primary);
    color: var(--color-bg-primary);
  }

  .language-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background-color: var(--color-bg-primary);
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    min-width: 180px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 100;
  }

  [data-theme="dark"] .language-dropdown {
    background-color: #1e293b;
    border: 2px solid var(--color-primary);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  }

  .language-dropdown[hidden] {
    display: none;
  }

  .language-option {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    width: 100%;
    padding: 0.75rem 1rem;
    background: none;
    color: var(--color-text-primary);
    text-align: left;
    transition: background-color var(--transition-fast);
    border: none;
    cursor: pointer;
    font-family: var(--font-sans);
    font-weight: 500;
  }

  .language-option:hover {
    background-color: var(--color-bg-secondary);
    color: var(--color-primary);
  }

  .language-option[data-active="true"] {
    background-color: var(--color-primary);
    color: var(--color-bg-primary);
    font-weight: 600;
  }

  [data-theme="dark"] .language-option {
    color: #f1f5f9;
  }

  [data-theme="dark"] .language-option:hover {
    background-color: #334155;
    color: var(--color-primary);
  }

  [data-theme="dark"] .language-option[data-active="true"] {
    background-color: var(--color-primary);
    color: var(--color-bg-primary);
  }

  .lang-code {
    font-weight: 700;
    color: var(--color-primary);
    min-width: 30px;
  }

  .lang-name {
    font-size: 0.875rem;
    flex: 1;
  }

  .lang-check {
    color: var(--color-primary);
    margin-left: auto;
  }
</style>

<script>
  const languageToggle = document.getElementById('language-toggle');
  const languageDropdown = document.getElementById('language-dropdown');
  const languageOptions = document.querySelectorAll('.language-option');

  if (languageToggle && languageDropdown) {
    languageToggle.addEventListener('click', () => {
      const isHidden = languageDropdown.hasAttribute('hidden');
      if (isHidden) {
        languageDropdown.removeAttribute('hidden');
      } else {
        languageDropdown.setAttribute('hidden', '');
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!languageToggle.contains(e.target as Node) && !languageDropdown.contains(e.target as Node)) {
        languageDropdown.setAttribute('hidden', '');
      }
    });
  }

  languageOptions.forEach(option => {
    option.addEventListener('click', () => {
      const lang = option.getAttribute('data-lang');
      if (lang) {
        // Save to localStorage
        localStorage.setItem('language', lang);
        
        const currentPath = window.location.pathname;
        const pathSegments = currentPath.split('/').filter(Boolean);
        
        // Get the list of supported languages
        const supportedLangs = ['es', 'en', 'fr', 'de', 'it', 'pt', 'nl', 'pl', 'ru', 'ja'];
        
        // Remove language prefix if it exists
        if (supportedLangs.includes(pathSegments[0])) {
          pathSegments.shift();
        }
        
        // Navigate to the language-specific path
        const newPath = `/${lang}${pathSegments.length > 0 ? '/' + pathSegments.join('/') : ''}`;
        window.location.href = newPath;
      }
    });
  });
</script>
