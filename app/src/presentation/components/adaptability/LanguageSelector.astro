---
import type { Language } from '@/domain';
import { supportedLanguages, languageNames } from '@/domain';

interface Props {
    currentLang: Language;
}

const { currentLang } = Astro.props;

// Sort languages with current language first
const orderedLanguages = [
    currentLang,
    ...supportedLanguages.filter(lang => lang !== currentLang)
];
---

<div class="language-selector relative inline-block">
    <button
        class="language-button w-24 h-14"
        aria-label="Change language"
        title="Change language"
    >
        <span class="current-lang text-xl">{currentLang.toUpperCase()}</span>
        <svg class="size-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
        </svg>
    </button>
    
    <div class="language-dropdown absolute top-full right-0 mt-2 bg-bg-surface-alt-v border-2 border-primary-v rounded-md shadow-lg" hidden>
        {orderedLanguages.map((lng) => (
            <button class="language-option" data-lang={lng} data-active={lng === currentLang ? 'true' : 'false'}>
                <span class="lang-code">{lng.toUpperCase()}</span>
                <span class="lang-name">{languageNames[lng]}</span>
                {lng === currentLang ? (
                    <svg class="w-4 h-4" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                ) : (
                    <svg class="w-4 h-4 hidden" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                )}
            </button>
        ))}
    </div>
</div>

<script>
    // Wire the selector per-instance to avoid duplicated ids issues when component is used multiple times
    const selectors = Array.from(document.querySelectorAll('.language-selector')) as HTMLElement[];

    selectors.forEach(sel => {
        const languageToggle = sel.querySelector('.language-button') as HTMLButtonElement | null;
        const languageDropdown = sel.querySelector('.language-dropdown') as HTMLElement | null;
        const languageOptions = Array.from(sel.querySelectorAll('.language-option')) as HTMLElement[];

        if (!languageToggle || !languageDropdown) return;

        languageToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = languageDropdown.hasAttribute('hidden');
            if (isHidden) languageDropdown.removeAttribute('hidden'); else languageDropdown.setAttribute('hidden', '');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!sel.contains(e.target as Node)) {
                languageDropdown.setAttribute('hidden', '');
            }
        });

        languageOptions.forEach(option => {
            option.addEventListener('click', () => {
                const lang = option.getAttribute('data-lang');
                if (!lang) return;

                const currentPath = window.location.pathname;
                const pathSegments = currentPath.split('/').filter(Boolean);

                // If first segment is a two-letter code, remove it
                if (pathSegments[0] && pathSegments[0].length === 2) pathSegments.shift();

                const newPath = `/${lang}/${pathSegments.join('/')}`;
                window.location.href = newPath;
            });
        });
    });
</script>
